<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="os-map">

  <template>

    <style>
      /* local styles go here */
      :host {
        display: inline-block;
      }
      .os-maps {
        width: 100%;
        height: 100%;
        padding: 0px;
        margin: 0px;
      }
    </style>

    <!-- local DOM goes here -->
    <div
          id="{{mapId}}"
          class="os-maps"
          crs="{{crs}}"
          zoom={{zoom::change}}
          center={{center::change}}
          basemap="{{basemap::change}}">
    </div>

  </template>

  <script src="apikey.js"></script> <!-- Your API key for OS services -->
  <script>
      var instances = [];

      Polymer({
          is : 'os-map',
          properties : {
            mapId : String,
            zoom : {
              value: 7,
              type: Number,
              notify: true,
              reflectToAttribute: true,
              observer: 'zoomChange'
            },
            center : {
              type : String,
              value : "53.8,-1.5",
              notify: true,
              reflectToAttribute: true,
              observer: 'centerChange'
            },
            crs : {
              type: String,
              value: "wgs84",
              notify: true,
              reflectToAttribute: true
            },
            basemap : {
              type: String,
              notify: true,
              reflectToAttribute: true,
              observer: 'basemapChange'
            }
          },
          attached: function() {

            console.log("Initialising map...")
            var component = this;
            instances.push(this);
            this.mapId = "os-map-" + instances.length;

            this.os = {
              'road'    : 'https://api2.ordnancesurvey.co.uk/mapping_api/v1/service/zxy/EPSG%3A3857/Road 3857/{z}/{x}/{y}.png?key=',
              'outdoor' : 'https://api2.ordnancesurvey.co.uk/mapping_api/v1/service/zxy/EPSG%3A3857/Outdoor 3857/{z}/{x}/{y}.png?key=',
              'light'   : 'https://api2.ordnancesurvey.co.uk/mapping_api/v1/service/zxy/EPSG%3A3857/Light 3857/{z}/{x}/{y}.png?key=',
              'night'   : 'https://api2.ordnancesurvey.co.uk/mapping_api/v1/service/zxy/EPSG%3A3857/Night 3857/{z}/{x}/{y}.png?key=',
              'attrib'  : '&copy; <a href="https://www.os.uk/copyright">Ordnance Survey</a>',
              'key'     :  osApiKey
            }

            console.log(this.center);

            this.minZoom = 7; // Minimum zoom level for the map
            this.map = L.map(this.mapId, {minZoom: this.minZoom});
            this.setView(this.center);

            this.basemapLayer = L.tileLayer(this.os[this.basemap] + this.os.key, {
              attribution: this.os.attrib
            }).addTo(this.map);

            // Event Listenrs

            this.map.on("zoomend", function(event) {

                component.zoom = component.map.getZoom(); // Update the zoom attribute to reflect the maps zoom

            })

          },
          detached: function(){

              instances = instances.filter(function(instance){
                  return instance !== this;
              }.bind(this));

          },
          basemapChange : function(newBasemap, oldBasemap) {

            if (oldBasemap && newBasemap && newBasemap !== oldBasemap) {
              this.map.removeLayer( this.basemapLayer );
              this.basemapLayer = L.tileLayer(this.os[newBasemap] + this.os.key, {
                attribution: this.os.attrib
              }).addTo(this.map);
            }

          },
          zoomChange : function(newZoom, oldZoom) {

            if (oldZoom && newZoom && newZoom !== oldZoom && newZoom > this.minZoom) {
              this.map.setZoom(newZoom);
            } else if (newZoom < this.minZoom) {
              this.zoom = this.minZoom; // Prevent zoom going below 6 as this puts the map to grey
            }

          },
          centerChange : function(newCenter, oldCenter) {

           if (oldCenter && newCenter && newCenter !== oldCenter) {
             setView(newCenter);
           }

         },
         setView : function(center) {

           var lat = center.split(",")[0].trim();
           var lng = center.split(",")[1].trim();
           if (this.crs === "bng") {
             var xy = new OsGridRef(lat, lng); // Use the Geodesy library
             latLng = OsGridRef.osGridToLatLon(xy); // Convert Os Grid reference to WGS84

             this.map.setView([latLng.lat, latLng.lon], this.zoom);
           }
           else if (this.crs === "wgs84") {
             this.map.setView([lat, lng], this.zoom);
           }
         }
      });

  </script>

</dom-module>
